name: device-registry-service CD

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (default: main)"
        required: false
        type: string

concurrency:
  group: cd-dev
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  deploy-dev:
    name: Deploy to dev (self-hosted)
    runs-on: self-hosted

    env:
      DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}        # e.g. /opt/device-register-service
      SERVICE_NAME: ${{ vars.SERVICE_NAME }}      # e.g. device-registry-service
      REGISTRY: ghcr.io

      # Where compose lives in the repo checkout (change if not repo root)
      COMPOSE_SRC: docker-compose.yml
      COMPOSE_OVERRIDE_SRC: docker-compose.override.yml

    steps:
      - name: Checkout repo (source of truth for compose)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Sanity checks
        shell: bash
        run: |
          set -euxo pipefail

          : "${DEPLOY_PATH:?DEPLOY_PATH is not set (Actions variable DEPLOY_PATH)}"
          : "${SERVICE_NAME:?SERVICE_NAME is not set (Actions variable SERVICE_NAME)}"
          : "${COMPOSE_SRC:?COMPOSE_SRC is not set}"

          echo "Runner identity:"
          whoami
          id

          echo "Docker:"
          docker version
          docker compose version

          echo "Repo compose file:"
          test -f "$COMPOSE_SRC"

          echo "Deploy folder:"
          test -d "$DEPLOY_PATH"
          test -f "$DEPLOY_PATH/.env"

      - name: Login to GHCR
        shell: bash
        run: |
          set -euxo pipefail
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login "$REGISTRY" \
            -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

      - name: Sync docker-compose from repo -> deploy folder
        shell: bash
        run: |
          set -euxo pipefail

          install -m 0644 "$COMPOSE_SRC" "$DEPLOY_PATH/docker-compose.yml"

          if [ -f "$COMPOSE_OVERRIDE_SRC" ]; then
            install -m 0644 "$COMPOSE_OVERRIDE_SRC" "$DEPLOY_PATH/docker-compose.override.yml"
          else
            rm -f "$DEPLOY_PATH/docker-compose.override.yml" || true
          fi

          echo "Deploy folder content:"
          ls -la "$DEPLOY_PATH"

      - name: Ensure GHCR image variables exist in server .env
        shell: bash
        env:
          # GHCR image name matches your CI: IMAGE_NAME = github.repository (owner/repo)
          IMAGE_NAME: ${{ github.repository }}
          # Default tag: main, but can be overridden by workflow_dispatch input
          IMAGE_TAG: ${{ github.event.inputs.image_tag }}
        run: |
          set -euxo pipefail

          ENV_FILE="$DEPLOY_PATH/.env"

          # Defaults if not provided
          if [ -z "${IMAGE_TAG:-}" ]; then
            IMAGE_TAG="main"
          fi

          # Helper: set or replace KEY=VALUE in .env
          set_kv() {
            local key="$1"
            local val="$2"
            if grep -qE "^${key}=" "$ENV_FILE"; then
              # replace existing line
              sed -i -E "s|^${key}=.*|${key}=${val}|" "$ENV_FILE"
            else
              # append
              echo "${key}=${val}" >> "$ENV_FILE"
            fi
          }

          set_kv "REGISTRY" "ghcr.io"
          set_kv "IMAGE_NAME" "$IMAGE_NAME"
          set_kv "IMAGE_TAG" "$IMAGE_TAG"

          echo "Updated image selection:"
          grep -E '^(REGISTRY|IMAGE_NAME|IMAGE_TAG)=' "$ENV_FILE"

      - name: Deploy (pull + recreate)
        shell: bash
        run: |
          set -euxo pipefail

          COMPOSE_ARGS=(-f "$DEPLOY_PATH/docker-compose.yml")
          if [ -f "$DEPLOY_PATH/docker-compose.override.yml" ]; then
            COMPOSE_ARGS+=(-f "$DEPLOY_PATH/docker-compose.override.yml")
          fi

          echo "Rendered compose config (first ~200 lines):"
          docker compose "${COMPOSE_ARGS[@]}" --env-file "$DEPLOY_PATH/.env" config | sed -n '1,200p'

          echo "Pulling service: $SERVICE_NAME"
          docker compose "${COMPOSE_ARGS[@]}" --env-file "$DEPLOY_PATH/.env" pull "$SERVICE_NAME"

          echo "Updating container:"
          docker compose "${COMPOSE_ARGS[@]}" --env-file "$DEPLOY_PATH/.env" up -d \
            --no-deps \
            --pull always \
            --force-recreate \
            "$SERVICE_NAME"

          echo "Containers:"
          docker ps

          echo "Recent logs:"
          docker compose "${COMPOSE_ARGS[@]}" --env-file "$DEPLOY_PATH/.env" logs --no-color --tail=120 "$SERVICE_NAME" || true
