name: device-registry-service CD

on:
  workflow_dispatch:

concurrency:
  group: cd-dev
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  deploy-dev:
    name: Deploy to dev (self-hosted)
    runs-on: self-hosted
   #environment: dev

    env:
      REPO_DIR: ${{ vars.DEPLOY_PATH }}      # now this is the repo clone dir
      SERVICE_NAME: ${{ vars.SERVICE_NAME }}
      REGISTRY: ghcr.io

    steps:
      - name: Sanity checks
        shell: bash
        run: |
          set -euxo pipefail
          whoami
          id
          docker version
          docker compose version

          test -d "$REPO_DIR"
          test -d "$REPO_DIR/.git"
          test -f "$REPO_DIR/docker-compose.yml"
          test -f "$REPO_DIR/.env"

      - name: Update repo to latest main
        shell: bash
        run: |
          set -euxo pipefail
          cd "$REPO_DIR"
          git fetch origin
          git checkout -f main
          git reset --hard origin/main

      - name: Login to GHCR
        shell: bash
        run: |
          set -euxo pipefail
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login "$REGISTRY" \
            -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

      - name: Deploy (pull + replace container)
        shell: bash
        run: |
          set -euxo pipefail
          cd "$REPO_DIR"

          docker compose pull "$SERVICE_NAME"
          docker compose up -d --no-deps --pull always --force-recreate "$SERVICE_NAME"

          docker ps
          docker compose logs --no-color --tail=120 "$SERVICE_NAME" || true
