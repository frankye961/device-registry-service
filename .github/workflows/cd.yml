name: device-registry-service CD

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (default: main)"
        required: false
        type: string

concurrency:
  group: cd-dev
  cancel-in-progress: true

permissions:
  contents: read
  packages: read

jobs:
  deploy-dev:
    name: Deploy to dev (self-hosted)
    runs-on: self-hosted

    env:
      DEPLOY_PATH: ${{ vars.DEPLOY_PATH }}        # e.g. /opt/device-register-service
      SERVICE_NAME: ${{ vars.SERVICE_NAME }}      # e.g. device-registry-service
      REGISTRY: ghcr.io

      COMPOSE_SRC: docker-compose.yml
      COMPOSE_OVERRIDE_SRC: docker-compose.override.yml

    steps:
      - name: Checkout repo (source of truth for compose)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Sanity checks
        shell: bash
        run: |
          set -euxo pipefail
          : "${DEPLOY_PATH:?DEPLOY_PATH is not set}"
          : "${SERVICE_NAME:?SERVICE_NAME is not set}"
          test -f "$COMPOSE_SRC"
          test -d "$DEPLOY_PATH"
          test -f "$DEPLOY_PATH/.env"

          whoami
          id
          docker version
          docker compose version

      - name: Login to GHCR
        shell: bash
        run: |
          set -euxo pipefail
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login "$REGISTRY" \
            -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

      - name: Sync docker-compose from repo -> deploy folder
        shell: bash
        run: |
          set -euxo pipefail
          install -m 0644 "$COMPOSE_SRC" "$DEPLOY_PATH/docker-compose.yml"

          if [ -f "$COMPOSE_OVERRIDE_SRC" ]; then
            install -m 0644 "$COMPOSE_OVERRIDE_SRC" "$DEPLOY_PATH/docker-compose.override.yml"
          else
            rm -f "$DEPLOY_PATH/docker-compose.override.yml" || true
          fi

      - name: Generate image override (force GHCR image)
        shell: bash
        env:
          IMAGE_NAME: ${{ github.repository }}                # owner/repo (matches CI)
          INPUT_TAG: ${{ github.event.inputs.image_tag }}     # optional
        run: |
          set -euxo pipefail

          TAG="${INPUT_TAG:-main}"
          IMAGE_REF="${REGISTRY}/${IMAGE_NAME}:${TAG}"

          # Force the service image regardless of what base compose says
          cat > "$DEPLOY_PATH/compose.image.override.yml" <<EOF
services:
  ${SERVICE_NAME}:
    image: "${IMAGE_REF}"
  EOF
  
  echo "Forcing image:"
  cat "$DEPLOY_PATH/compose.image.override.yml"
  
  # Quick check that the tag exists and credentials work (after docker login)
  # If this fails, CI didnâ€™t push that tag or token lacks read:packages.
  docker manifest inspect "$IMAGE_REF" >/dev/null

- name: Deploy (pull + recreate)
  shell: bash
  run: |
    set -euxo pipefail
    
    COMPOSE_ARGS=(-f "$DEPLOY_PATH/docker-compose.yml")
    
    # keep your repo override if present
    if [ -f "$DEPLOY_PATH/docker-compose.override.yml" ]; then
      COMPOSE_ARGS+=(-f "$DEPLOY_PATH/docker-compose.override.yml")
    fi
    
    # force image override ALWAYS last
    COMPOSE_ARGS+=(-f "$DEPLOY_PATH/compose.image.override.yml")
    
    echo "Rendered compose config (showing the resolved image):"
    docker compose "${COMPOSE_ARGS[@]}" --env-file "$DEPLOY_PATH/.env" config | sed -n '1,220p'
    
    docker compose "${COMPOSE_ARGS[@]}" --env-file "$DEPLOY_PATH/.env" pull "$SERVICE_NAME"
    
    docker compose "${COMPOSE_ARGS[@]}" --env-file "$DEPLOY_PATH/.env" up -d \
      --no-deps \
      --pull always \
      --force-recreate \
      "$SERVICE_NAME"
    
    docker ps
    docker compose "${COMPOSE_ARGS[@]}" --env-file "$DEPLOY_PATH/.env" logs --no-color --tail=120 "$SERVICE_NAME" || true
